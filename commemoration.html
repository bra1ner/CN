<!doctype html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Coptic Note – Commemoration</title>
    <meta
      name="description"
      content="Submit memorial names for the departed. Choose your church and record names for recently departed, the 40th day and annual commemorations."
    />

    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png" />
    <link rel="manifest" href="icons/site.webmanifest" />

    <link rel="preload" href="assets/coptices-note.png" as="image" type="image/png" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RJ9ZRC3PW3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-RJ9ZRC3PW3");
    </script>

    <style>
      /* Root colour palette: white background with dark red accents */
      :root {
        --bg: #faf7f2;
        --paper: #ffffff;
        --border: #e2e2e0;
        --text: #2a2a2a;
        --muted: #6c6c6b;
        --accent: #800000;
        --accent-light: #a52a2a;
        --gold: #c8a951; /* gold accent */
        --focus-ring: rgba(200, 169, 81, 0.3); /* gold highlight */

        /* Spacing + radius */
        --field-pad: 14px;
        --field-radius: 12px;

        /* Responsive helpers */
        --page-pad: clamp(12px, 2.5vw, 28px);
        --card-pad: clamp(16px, 3vw, 28px);
        --btn-pad-y: clamp(10px, 1.8vh, 14px);
        --btn-pad-x: clamp(14px, 3vw, 22px);
        --control-font: clamp(0.95rem, 0.9rem + 0.3vw, 1rem);
        --h1-size: clamp(1.25rem, 1.05rem + 1.2vw, 1.6rem);
        --note-size: clamp(0.82rem, 0.78rem + 0.2vw, 0.9rem);
        --social-size: clamp(48px, 7vw, 64px);
        --social-icon: clamp(22px, 3.2vw, 28px);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: var(--page-pad);
        font-family: "Noto Sans", Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        flex-direction: column;
        gap: 12px;
      }

      .card {
        background: var(--paper);
        border: 1px solid var(--border);
        border-radius: 16px;
        width: 100%;
        max-width: 600px;
        padding: var(--card-pad);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-inline: auto;
      }

      /* ===== Header ===== */
      .header {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 16px;
        text-align: center;
      }

      .header img {
        height: clamp(48px, 7vw, 64px);
        width: auto;
        display: block;
      }

      h1 {
        margin: 0;
        font-size: var(--h1-size);
        font-weight: 700;
        color: var(--accent);
        text-align: center;
      }

      .form-group {
        margin-bottom: clamp(14px, 2.2vw, 20px);
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--accent);
        font-size: clamp(0.95rem, 0.9rem + 0.3vw, 1rem);
      }

      select,
      input[type="text"],
      textarea {
        display: block;
        width: 100%;
        border: 1px solid var(--border);
        border-radius: var(--field-radius);
        background: #fff;
        padding-block: clamp(10px, 1.8vh, 12px);
        padding-inline: var(--field-pad);
        font-size: var(--control-font);
        color: var(--text);
        outline: none;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }

      select:focus,
      input[type="text"]:focus,
      textarea:focus {
        border-color: var(--gold);
        box-shadow: 0 0 0 3px var(--focus-ring);
      }

      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%237d1a1a' d='M4 6l4 4 4-4z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px 16px;
        padding-right: calc(var(--field-pad) + 24px);
      }

      html[dir="rtl"] select {
        background-position: left 12px center;
        padding-left: calc(var(--field-pad) + 24px);
        padding-right: var(--field-pad);
      }

      textarea {
        min-height: clamp(100px, 18vh, 220px);
        resize: vertical;
      }

      .note {
        font-size: var(--note-size);
        color: var(--muted);
      }

      button {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: var(--btn-pad-y) var(--btn-pad-x);
        font-size: var(--control-font);
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.15s ease, box-shadow 0.15s ease;
      }

      button:hover {
        background: var(--accent-light);
        box-shadow: 0 0 8px var(--gold);
      }

      /* Language switch */
      .lang-switch {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: clamp(8px, 1.8vw, 12px);
        margin: 0 0 18px;
        width: 100%;
        direction: ltr;
      }

      #lang-en {
        order: 0;
      }
      #lang-ar {
        order: 1;
      }

      .lang-switch button {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 8px 14px;
        border-radius: 8px;
        font-size: var(--control-font);
        line-height: 1;
        min-width: 110px;
        flex: 0 0 auto;
      }

      .lang-switch button.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      .status-message {
        margin-top: 12px;
        font-weight: 600;
      }
      .status-ok {
        color: #1d8e53;
      }
      .status-error {
        color: #b12b2b;
      }

      /* Category sections */
      .category-section {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        margin-top: 12px;
        margin-bottom: 16px;
        display: none;
        background: var(--paper);
      }

      .category-header {
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 6px;
      }

      .dual-textareas {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .dual-textareas .half {
        flex: 1 1 48%;
        min-width: 240px;
      }

      .dual-textareas label {
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 4px;
      }

      @media (max-width: 480px) {
        .dual-textareas {
          gap: 10px;
        }

        .dual-textareas .half {
          flex: 1 1 48%;
          min-width: 0;
        }

        textarea {
          min-height: 140px;
        }
      }

      .radio-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .radio-group label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin: 0;
        font-weight: 600;
        color: var(--text);
      }
      .radio-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--accent);
      }
      html[dir="rtl"] .radio-group {
        justify-content: flex-start;
      }

      /* ============================
         FIX: action buttons swap
         ============================ */
      .form-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-top: 14px;
        width: 100%;

        /* CRITICAL: keep this row in LTR so "order" behaves predictably */
        direction: ltr;
        flex-direction: row;
      }

      /* LTR: Submit LEFT, Prayer RIGHT */
      html[dir="ltr"] #submitBtn {
        order: 0;
      }
      html[dir="ltr"] #prayernoteLink {
        order: 1;
      }

      /* RTL: Prayer LEFT, Submit RIGHT */
      html[dir="rtl"] #submitBtn {
        order: 1;
      }
      html[dir="rtl"] #prayernoteLink {
        order: 0;
      }

      #submitBtn {
        margin-top: 0;
        flex: 0 0 auto;
      }

      .prayernote-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: var(--btn-pad-y) var(--btn-pad-x);
        border-radius: 10px;
        background: #000;
        color: #fff;
        border: none;
        font-size: var(--control-font);
        font-weight: 600;
        line-height: 1;
        text-decoration: none;
        cursor: pointer;
        white-space: nowrap;
        width: auto;
        max-width: 100%;
        flex: 0 0 auto;
        transition: box-shadow 0.15s ease, transform 0.15s ease,
          background-color 0.15s ease;
      }

      .prayernote-btn:hover {
        box-shadow: 0 0 0 3px var(--focus-ring);
        transform: translateY(-1px);
        background: #111;
      }

      /* ✅ MOBILE: keep BOTH buttons on ONE ROW and equal width */
      @media (max-width: 520px) {
        .form-actions {
          align-items: stretch;
          gap: 10px;
        }

        #submitBtn,
        #prayernoteLink {
          flex: 1 1 0;
          width: auto !important;
        }
      }

      /* === Translate UI (per-section) === */
      .translate-row {
        margin-top: 8px;
      }

      .buttons-group {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      .translate-status {
        margin-top: 2px;
      }

      .translate-btn {
        background: #d3d3d3;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 8px 14px;
        border-radius: 8px;
        font-size: var(--control-font);
        line-height: 1;
        cursor: pointer;
        white-space: nowrap;
      }

      .translate-btn:hover {
        background: #f8f8f8;
      }

      .translate-btn.busy {
        width: auto !important;
        min-width: 0 !important;
        max-width: none !important;
      }

      /* === Social buttons strip UNDER the card === */
      .social-row {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .social-btn {
        width: var(--social-size);
        height: var(--social-size);
        background: #ffffff;
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        user-select: none;
        transition: box-shadow 0.15s ease, transform 0.15s ease,
          border-color 0.15s ease;
      }

      .social-btn:hover {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--focus-ring);
        transform: translateY(-1px);
      }

      .social-btn img {
        width: var(--social-icon);
        height: var(--social-icon);
        display: block;
      }
    </style>
  </head>

  <body>
    <div class="card">
      <div class="header">
        <img
          src="assets/coptices-note.png"
          alt="Coptic Note logo"
          width="64"
          height="64"
          fetchpriority="high"
          decoding="sync"
        />
        <h1 id="pageTitle">Commemoration</h1>
        <div style="width: 60px; height: 2px; background: var(--gold)"></div>
      </div>

      <!-- Language switch -->
      <div class="lang-switch">
        <button type="button" id="lang-en" class="active">English</button>
        <button type="button" id="lang-ar">العربية</button>
      </div>

      <form id="commemorationForm" novalidate>
        <div class="form-group">
          <label for="church" id="lbl-church">Choose Church</label>
          <select id="church" name="church" required aria-required="true"></select>
          <div class="note" id="help-church"></div>
        </div>

        <div class="form-group">
          <label id="lbl-remembrance">Remembrance</label>
          <div class="radio-group" id="remembrance-group">
            <label>
              <input type="checkbox" name="remembrance" value="recently" id="occ-recently" />
              <span id="lbl-occasion-recently">Recently</span>
            </label>
            <label>
              <input type="checkbox" name="remembrance" value="40th" id="occ-40th" />
              <span id="lbl-occasion-40">40th Day</span>
            </label>
            <label>
              <input type="checkbox" name="remembrance" value="yearly" id="occ-yearly" />
              <span id="lbl-occasion-yearly">Annually</span>
            </label>
          </div>
        </div>

        <!-- Recently -->
        <div class="category-section" id="section-recently">
          <div class="category-header" id="lbl-cat-recently">Recently</div>
          <div class="dual-textareas">
            <div class="half">
              <label for="male-recently" id="lbl-male-recently">Male</label>
              <textarea id="male-recently" name="male_recently" placeholder="Enter names"></textarea>
            </div>
            <div class="half">
              <label for="female-recently" id="lbl-female-recently">Female</label>
              <textarea
                id="female-recently"
                name="female_recently"
                placeholder="Enter names"
              ></textarea>
            </div>
          </div>

          <div class="translate-row">
            <div class="buttons-group">
              <button type="button" class="translate-btn" data-translate-scope="recently">
                Translate
              </button>
              <div class="note translate-status" id="translate-status-recently"></div>
            </div>
          </div>
        </div>

        <!-- 40th Day -->
        <div class="category-section" id="section-40th">
          <div class="category-header" id="lbl-cat-40th">40th Day</div>
          <div class="dual-textareas">
            <div class="half">
              <label for="male-40th" id="lbl-male-40th">Male</label>
              <textarea id="male-40th" name="male_40th" placeholder="Enter names"></textarea>
            </div>
            <div class="half">
              <label for="female-40th" id="lbl-female-40th">Female</label>
              <textarea id="female-40th" name="female_40th" placeholder="Enter names"></textarea>
            </div>
          </div>

          <div class="translate-row">
            <div class="buttons-group">
              <button type="button" class="translate-btn" data-translate-scope="40th">
                Translate
              </button>
              <div class="note translate-status" id="translate-status-40th"></div>
            </div>
          </div>
        </div>

        <!-- Annually -->
        <div class="category-section" id="section-yearly">
          <div class="category-header" id="lbl-cat-yearly">Annually</div>
          <div class="dual-textareas">
            <div class="half">
              <label for="male-yearly" id="lbl-male-yearly">Male</label>
              <textarea id="male-yearly" name="male_yearly" placeholder="Enter names"></textarea>
            </div>
            <div class="half">
              <label for="female-yearly" id="lbl-female-yearly">Female</label>
              <textarea
                id="female-yearly"
                name="female_yearly"
                placeholder="Enter names"
              ></textarea>
            </div>
          </div>

          <div class="translate-row">
            <div class="buttons-group">
              <button type="button" class="translate-btn" data-translate-scope="yearly">
                Translate
              </button>
              <div class="note translate-status" id="translate-status-yearly"></div>
            </div>
          </div>
        </div>

        <!-- Actions row -->
        <div class="form-actions">
          <button type="submit" id="submitBtn">Submit</button>

          <a class="prayernote-btn" id="prayernoteLink" href="https://copticnote.com">
            Prayer Note
          </a>
        </div>

        <div class="status-message status-ok" id="status-ok" style="display: none"></div>
        <div class="status-message status-error" id="status-error" style="display: none"></div>
      </form>
    </div>

    <!-- Social buttons row under the card -->
    <div class="social-row" aria-label="Social links">
      <a
        class="social-btn"
        href="https://instagram.com/copticnote"
        aria-label="Instagram"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img src="social/instagram.png" alt="Instagram" />
      </a>

      <a
        class="social-btn"
        href="https://discord.gg/7fxRTfNdC2"
        aria-label="Discord"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img src="social/discord.png" alt="Discord" />
      </a>

      <a
        class="social-btn"
        href="https://www.linkedin.com/company/coptic-note/"
        aria-label="LinkedIn"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img src="social/in.png" alt="LinkedIn" />
      </a>

      <a
        class="social-btn"
        href="https://x.com/CopticNote"
        aria-label="X / Twitter"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img src="social/x.png" alt="X/Twitter" />
      </a>

      <a
        class="social-btn"
        href="https://facebook.com/CopticNote"
        aria-label="Facebook"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img src="social/facebook.png" alt="Facebook" />
      </a>
    </div>

    <script>
      const API_BASE = "https://api.copticnote.com";

      /* Translation strings for English and Arabic */
      const translations = {
        en: {
          pageTitle: "Commemoration",
          church: "Choose Church",
          helpChurch: "Select your parish so the list prints in the right place.",
          remembrance: "Remembrance",
          occasionRecently: "Recently",
          occasion40: "40th Day",
          occasionYearly: "Annually",
          categoryRecently: "Recently",
          category40: "40th Day",
          categoryYearly: "Annually",
          male: "Male",
          female: "Female",
          placeholderNames: "Enter names",
          submit: "Submit",
          ok: "Your names have been recorded.",
          err: "There was a problem. Please try again.",
          needOccasion: "Please choose at least one remembrance and enter names for each.",
          needNamesForCategory:
            "For each selected remembrance, enter at least one name (male or female).",
          invalidNamesFormat:
            "Please enter valid names (letters only, avoid random symbols or numbers).",
          prayerNoteBtn: "Prayer Note",

          translateBtn: "Translate",
          translating: "Translating…",
          translateErrEmpty: "Write something to translate.",
          translateErrGeneric: "Translation failed. Please try again.",
          translatedToAr: "Translated to Arabic.",
          translatedToEn: "Translated to English.",
        },
        ar: {
          pageTitle: "صلاة الترحيم",
          church: "اختر الكنيسة",
          helpChurch: "اختر كنيستك لضمان طباعة الطلب في المكان الصحيح.",
          remembrance: "الذكرى",
          occasionRecently: "حديثًا",
          occasion40: "الأربعين",
          occasionYearly: "السنوية",
          categoryRecently: "حديثًا",
          category40: "الأربعين",
          categoryYearly: "السنوية",
          male: "رجال",
          female: "سيدات",
          placeholderNames: "اكتب الأسماء",
          submit: "إرسال",
          ok: "تم تسجيل الأسماء.",
          err: "حدث خطأ، يرجى المحاولة مرة أخرى.",
          needOccasion: "يرجى اختيار مناسبة واحدة على الأقل وإدخال أسماء لكل منها.",
          needNamesForCategory: "لكل ذكرى تختارها، اكتب اسمًا واحدًا على الأقل (رجال أو سيدات).",
          invalidNamesFormat:
            "يرجى إدخال أسماء صحيحة (حروف فقط وبدون رموز أو أرقام عشوائية).",
          prayerNoteBtn: "صلاة الطلبة",

          translateBtn: "ترجمة",
          translating: "جارٍ الترجمة…",
          translateErrEmpty: "اكتب ما تريد ترجمته أولًا.",
          translateErrGeneric: "فشلت الترجمة. حاول مرة أخرى.",
          translatedToAr: "تمت الترجمة إلى العربية.",
          translatedToEn: "تمت الترجمة إلى الإنجليزية.",
        },
      };

      let currentLang = "en";

      function $(id) {
        return document.getElementById(id);
      }

      /* EXTRA SAFETY: enforce order inline (beats any weird browser RTL behavior) */
      function forceActionButtonsOrder() {
        const submit = $("submitBtn");
        const prayer = $("prayernoteLink");
        if (!submit || !prayer) return;

        if (document.documentElement.dir === "rtl") {
          prayer.style.order = "0";
          submit.style.order = "1";
        } else {
          submit.style.order = "0";
          prayer.style.order = "1";
        }
      }

      /* Match Submit width to Prayer Note (desktop/tablet). On mobile CSS makes them equal. */
      function syncSubmitToPrayerNoteWidth() {
        const submit = $("submitBtn");
        const prayer = $("prayernoteLink");
        if (!submit || !prayer) return;

        submit.style.width = "";

        const isMobileRow = window.matchMedia("(max-width: 520px)").matches;
        if (isMobileRow) return;

        const w = Math.ceil(prayer.getBoundingClientRect().width);
        submit.style.width = w + "px";
      }

      /* Apply translations to the page */
      function applyTranslations() {
        const t = translations[currentLang];
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";

        $("pageTitle").textContent = t.pageTitle;

        $("lbl-church").textContent = t.church;
        $("help-church").textContent = t.helpChurch;
        $("lbl-remembrance").textContent = t.remembrance;

        $("lbl-occasion-recently").textContent = t.occasionRecently;
        $("lbl-occasion-40").textContent = t.occasion40;
        $("lbl-occasion-yearly").textContent = t.occasionYearly;

        $("lbl-cat-recently").textContent = t.categoryRecently;
        $("lbl-cat-40th").textContent = t.category40;
        $("lbl-cat-yearly").textContent = t.categoryYearly;

        $("lbl-male-recently").textContent = t.male;
        $("lbl-female-recently").textContent = t.female;
        $("lbl-male-40th").textContent = t.male;
        $("lbl-female-40th").textContent = t.female;
        $("lbl-male-yearly").textContent = t.male;
        $("lbl-female-yearly").textContent = t.female;

        $("male-recently").placeholder = t.placeholderNames;
        $("female-recently").placeholder = t.placeholderNames;
        $("male-40th").placeholder = t.placeholderNames;
        $("female-40th").placeholder = t.placeholderNames;
        $("male-yearly").placeholder = t.placeholderNames;
        $("female-yearly").placeholder = t.placeholderNames;

        $("submitBtn").textContent = t.submit;
        $("prayernoteLink").textContent = t.prayerNoteBtn;

        document.querySelectorAll(".translate-btn").forEach((btn) => {
          btn.textContent = t.translateBtn;
        });

        forceActionButtonsOrder();
        syncSubmitToPrayerNoteWidth();
      }

      $("lang-en").addEventListener("click", () => {
        currentLang = "en";
        $("lang-en").classList.add("active");
        $("lang-ar").classList.remove("active");
        applyTranslations();
      });

      $("lang-ar").addEventListener("click", () => {
        currentLang = "ar";
        $("lang-ar").classList.add("active");
        $("lang-en").classList.remove("active");
        applyTranslations();
      });

      document.addEventListener("DOMContentLoaded", () => {
        applyTranslations();
        forceActionButtonsOrder();
        syncSubmitToPrayerNoteWidth();
      });

      let _btnResizeTimer2;
      window.addEventListener("resize", () => {
        clearTimeout(_btnResizeTimer2);
        _btnResizeTimer2 = setTimeout(() => {
          forceActionButtonsOrder();
          syncSubmitToPrayerNoteWidth();
        }, 120);
      });

      /* Load churches from API */
      async function loadChurches() {
        const select = $("church");
        select.innerHTML = "";

        try {
          const res = await fetch(`${API_BASE}/api/churches`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          const churches = Array.isArray(data.churches) ? data.churches : [];

          if (!churches.length) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = currentLang === "ar" ? "لا توجد كنائس" : "No churches found";
            select.appendChild(opt);
            return;
          }

          churches.forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.name;
            select.appendChild(opt);
          });
        } catch (err) {
          console.error("Failed to load churches:", err);
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = currentLang === "ar" ? "تعذر تحميل الكنائس" : "Failed to load churches";
          select.appendChild(opt);
        }
      }
      loadChurches();

      /* Show/hide category sections based on checkbox */
      function bindCategoryToggle(checkboxId, sectionId) {
        const cb = $(checkboxId);
        const section = $(sectionId);

        cb.addEventListener("change", () => {
          section.style.display = cb.checked ? "block" : "none";
          if (!cb.checked) {
            section.querySelectorAll("textarea").forEach((ta) => (ta.value = ""));
          }
        });
      }
      bindCategoryToggle("occ-recently", "section-recently");
      bindCategoryToggle("occ-40th", "section-40th");
      bindCategoryToggle("occ-yearly", "section-yearly");

      /* ============================================================
         INPUT FILTERING + 2 WORDS PER LINE + ONE SPACE BETWEEN WORDS
         ============================================================ */

      function sanitizeNamesInput(value) {
        const v = (value || "").normalize("NFC");
        let out = v.replace(/\p{N}+/gu, "");
        out = out.replace(/[^\p{L}\p{M}\s,]+/gu, "");
        out = out.replace(/,{2,}/g, ",");
        out = out.replace(/[^\S\r\n]{2,}/g, " ");
        return out;
      }

      function formatTwoWordsPerLine(value) {
        const v = (value || "").normalize("NFC");
        const lines = v.split("\n");
        const outLines = [];

        for (const rawLine of lines) {
          const hasTrailingSpace = /[^\S\r\n]$/.test(rawLine);
          const trimmed = rawLine.trim();

          if (!trimmed) {
            outLines.push("");
            continue;
          }

          const words = trimmed.split(/\s+/).filter(Boolean);

          if (words.length === 1 && hasTrailingSpace) {
            outLines.push(words[0] + " ");
            continue;
          }

          for (let i = 0; i < words.length; i += 2) {
            outLines.push(words.slice(i, i + 2).join(" "));
          }
        }

        return outLines.join("\n");
      }

      function countWordsInLine(line) {
        return (line.trim().match(/\S+/g) || []).length;
      }

      function getCurrentLineInfo(text, caretPos) {
        const upToCaret = text.slice(0, caretPos);
        const lineStart = upToCaret.lastIndexOf("\n") + 1;
        const lineEndIdx = text.indexOf("\n", caretPos);
        const lineEnd = lineEndIdx === -1 ? text.length : lineEndIdx;
        const line = text.slice(lineStart, lineEnd);
        return { lineStart, lineEnd, line };
      }

      function enforceTextboxRules(el) {
        if (!el) return;

        const applySanitizeAndFormat = () => {
          const before = el.value;
          const caret = el.selectionStart ?? before.length;

          let after = sanitizeNamesInput(before);
          after = formatTwoWordsPerLine(after);

          if (before !== after) {
            const delta = after.length - before.length;
            const newPos = Math.max(0, Math.min(after.length, caret + delta));
            el.value = after;
            try {
              el.setSelectionRange(newPos, newPos);
            } catch {}
          }
        };

        el.addEventListener("beforeinput", (e) => {
          if (e.inputType && e.inputType.startsWith("delete")) return;

          if (e.data) {
            const incoming = e.data;
            const ok = /^[\p{L}\p{M}\s,]+$/u.test(incoming);
            if (!ok) e.preventDefault();
            if (/\p{N}/u.test(incoming)) e.preventDefault();
          }

          if (e.data === " ") {
            const pos = el.selectionStart ?? 0;
            const prevChar = pos > 0 ? el.value[pos - 1] : "";

            if (prevChar === " " || prevChar === "\t") {
              e.preventDefault();
              return;
            }

            const { line } = getCurrentLineInfo(el.value, pos);
            const wordsNow = countWordsInLine(line);

            if (wordsNow >= 2) {
              e.preventDefault();
              const start = el.selectionStart ?? 0;
              const end = el.selectionEnd ?? start;
              el.setRangeText("\n", start, end, "end");
              return;
            }
          }
        });

        el.addEventListener("input", applySanitizeAndFormat);
        el.addEventListener("paste", () => setTimeout(applySanitizeAndFormat, 0));
      }

      [
        "male-recently",
        "female-recently",
        "male-40th",
        "female-40th",
        "male-yearly",
        "female-yearly",
      ].forEach((id) => enforceTextboxRules($(id)));

      /* ===== Translation providers (same logic as Prayer Note) ===== */

      function withTimeout(promise, ms = 9000) {
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), ms);
        return Promise.race([
          (async () => {
            try {
              return await promise(controller.signal);
            } finally {
              clearTimeout(t);
            }
          })(),
        ]);
      }

      const translators = [
        async (text, source, target, signal) => {
          const res = await fetch("https://libretranslate.com/translate", {
            method: "POST",
            signal,
            headers: { "Content-Type": "application/json", Accept: "application/json" },
            body: JSON.stringify({ q: text, source, target, format: "text" }),
          });
          if (!res.ok) throw new Error(`LT_main_${res.status}`);
          const j = await res.json();
          if (!j.translatedText) throw new Error("LT_main_no_text");
          return j.translatedText;
        },
        async (text, source, target, signal) => {
          const res = await fetch("https://translate.astian.org/translate", {
            method: "POST",
            signal,
            headers: { "Content-Type": "application/json", Accept: "application/json" },
            body: JSON.stringify({ q: text, source, target, format: "text" }),
          });
          if (!res.ok) throw new Error(`LT_ast_${res.status}`);
          const j = await res.json();
          if (!j.translatedText) throw new Error("LT_ast_no_text");
          return j.translatedText;
        },
        async (text, source, target, signal) => {
          const res = await fetch("https://libretranslate.de/translate", {
            method: "POST",
            signal,
            headers: { "Content-Type": "application/json", Accept: "application/json" },
            body: JSON.stringify({ q: text, source, target, format: "text" }),
          });
          if (!res.ok) throw new Error(`LT_de_${res.status}`);
          const j = await res.json();
          if (!j.translatedText) throw new Error("LT_de_no_text");
          return j.translatedText;
        },
        async (text, source, target, signal) => {
          const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(
            text
          )}&langpair=${source}|${target}`;
          const res = await fetch(url, { signal, headers: { Accept: "application/json" } });
          if (!res.ok) throw new Error(`MM_${res.status}`);
          const j = await res.json();
          const out = j?.responseData?.translatedText;
          if (!out) throw new Error("MM_no_text");
          return out;
        },
      ];

      async function translateText(text, source, target) {
        const errors = [];
        for (const fn of translators) {
          try {
            const result = await withTimeout((signal) => fn(text, source, target, signal), 9000);
            return result;
          } catch (e) {
            errors.push(e?.message || String(e));
          }
        }
        throw new Error("all_providers_failed: " + errors.join(" | "));
      }

      function looksArabic(text) {
        return /[\u0600-\u06FF]/.test(text);
      }

      function getScopeTextareas(scope) {
        if (scope === "recently") return ["male-recently", "female-recently"];
        if (scope === "40th") return ["male-40th", "female-40th"];
        if (scope === "yearly") return ["male-yearly", "female-yearly"];
        return [];
      }

      async function translateOneTextarea(ta) {
        const val = (ta.value || "").trim();
        if (!val) return null;

        const fromIsArabic = looksArabic(val);
        const source = fromIsArabic ? "ar" : "en";
        const target = fromIsArabic ? "en" : "ar";

        let out = await translateText(val, source, target);

        // Keep your existing name rules after translation
        out = formatTwoWordsPerLine(sanitizeNamesInput(out)).trim();

        ta.value = out;
        ta.setAttribute("dir", target === "ar" ? "rtl" : "ltr");
        return target;
      }

      async function handleSectionTranslate(scope, btn) {
        const t = translations[currentLang];
        const statusEl = document.getElementById(`translate-status-${scope}`);
        const ids = getScopeTextareas(scope);
        const textareas = ids.map((id) => document.getElementById(id)).filter(Boolean);

        statusEl.textContent = "";

        const hasAnyText = textareas.some((ta) => (ta.value || "").trim().length > 0);
        if (!hasAnyText) {
          statusEl.textContent = t.translateErrEmpty;
          return;
        }

        btn.classList.add("busy");
        btn.setAttribute("aria-busy", "true");
        btn.disabled = true;

        const oldBtnText = btn.textContent;
        btn.textContent = t.translating;

        try {
          let lastTarget = null;
          for (const ta of textareas) {
            if (!((ta.value || "").trim())) continue;
            lastTarget = await translateOneTextarea(ta);
          }

          statusEl.textContent =
            lastTarget === "ar" ? t.translatedToAr : t.translatedToEn;

          syncSubmitToPrayerNoteWidth();
        } catch (e) {
          console.error(e);
          statusEl.textContent = `${t.translateErrGeneric} (${e.message || "error"})`;
        } finally {
          btn.disabled = false;
          btn.textContent = oldBtnText;
          btn.classList.remove("busy");
          btn.removeAttribute("aria-busy");
        }
      }

      // Wire translate buttons
      document.querySelectorAll(".translate-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const scope = btn.getAttribute("data-translate-scope");
          handleSectionTranslate(scope, btn);
        });
      });

      /* ===== Validation ===== */
      function splitNames(str) {
        return (str || "")
          .split(/[\n,]+/g)
          .map((x) => x.trim())
          .filter(Boolean);
      }

      function hasLongRepeat(str) {
        return /(.)(\1){3,}/u.test(str);
      }

      function isValidPersonName(name) {
        const n = (name || "").trim();
        if (!n) return false;
        if (/\p{N}/u.test(n)) return false;
        const ok = /^[\p{L}\p{M}]+(?:\s[\p{L}\p{M}]+)*$/u.test(n);
        if (!ok) return false;
        const letterCount = (n.match(/\p{L}/gu) || []).length;
        if (letterCount < 2) return false;
        if (hasLongRepeat(n)) return false;
        return true;
      }

      function validateNamesOptional(str, t) {
        const s = (str || "").trim();
        if (!s) return null;

        const parts = splitNames(s);
        if (!parts.length) return t.invalidNamesFormat;

        for (const name of parts) {
          if (!isValidPersonName(name)) return t.invalidNamesFormat;
        }
        return null;
      }

      function showStatus(okText, errText) {
        const ok = $("status-ok");
        const err = $("status-error");
        ok.style.display = "none";
        err.style.display = "none";

        if (okText) {
          ok.textContent = okText;
          ok.style.display = "block";
        }
        if (errText) {
          err.textContent = errText;
          err.style.display = "block";
        }
      }

      /* ===== Form submission handler ===== */
      $("commemorationForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const t = translations[currentLang];

        const churchId = $("church").value;

        const payload = {
          churchId,
          lang: currentLang,
          categories: {},
        };

        let hasCategory = false;

        const addCategory = (cbId, key, maleId, femaleId) => {
          const cb = $(cbId);
          if (cb && cb.checked) {
            hasCategory = true;

            const maleNames = formatTwoWordsPerLine(sanitizeNamesInput($(maleId).value)).trim();
            const femaleNames = formatTwoWordsPerLine(sanitizeNamesInput($(femaleId).value)).trim();

            $(maleId).value = maleNames;
            $(femaleId).value = femaleNames;

            payload.categories[key] = { male: maleNames, female: femaleNames };
          }
        };

        addCategory("occ-recently", "recently", "male-recently", "female-recently");
        addCategory("occ-40th", "40th", "male-40th", "female-40th");
        addCategory("occ-yearly", "annually", "male-yearly", "female-yearly");

        if (!churchId) {
          showStatus(null, t.err);
          syncSubmitToPrayerNoteWidth();
          return;
        }

        if (!hasCategory) {
          showStatus(null, t.needOccasion);
          syncSubmitToPrayerNoteWidth();
          return;
        }

        for (const key of Object.keys(payload.categories)) {
          const cat = payload.categories[key];
          const male = (cat.male || "").trim();
          const female = (cat.female || "").trim();

          if (!male && !female) {
            showStatus(null, t.needNamesForCategory || t.needOccasion);
            syncSubmitToPrayerNoteWidth();
            return;
          }

          const maleErr = validateNamesOptional(male, t);
          if (maleErr) {
            showStatus(null, maleErr);
            syncSubmitToPrayerNoteWidth();
            return;
          }

          const femaleErr = validateNamesOptional(female, t);
          if (femaleErr) {
            showStatus(null, femaleErr);
            syncSubmitToPrayerNoteWidth();
            return;
          }
        }

        try {
          const res = await fetch(`${API_BASE}/api/submit-commemoration`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (res.ok) {
            $("commemorationForm").reset();
            ["section-recently", "section-40th", "section-yearly"].forEach((id) => {
              $(id).style.display = "none";
            });
            showStatus(t.ok, null);

            // Clear translate statuses
            ["recently", "40th", "yearly"].forEach((s) => {
              const el = document.getElementById(`translate-status-${s}`);
              if (el) el.textContent = "";
            });

            forceActionButtonsOrder();
            syncSubmitToPrayerNoteWidth();
          } else {
            const j = await res.json().catch(() => ({}));
            showStatus(null, j.error || t.err);

            forceActionButtonsOrder();
            syncSubmitToPrayerNoteWidth();
          }
        } catch (err) {
          showStatus(null, t.err);
          forceActionButtonsOrder();
          syncSubmitToPrayerNoteWidth();
        }
      });
    </script>
  </body>
</html>
