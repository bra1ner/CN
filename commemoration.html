<!doctype html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Coptic Note – Commemoration</title>
    <meta name="description" content="Submit memorial names for the departed. Choose your church and record names for recently departed, the 40th day and annual commemorations." />
    <link rel="icon" type="image/svg+xml" href="assets/favors.svg" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RJ9ZRC3PW3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-RJ9ZRC3PW3");
    </script>

    <style>
      /* palette variables and layout trimmed for brevity */
      /* … your existing CSS here … */
    </style>
  </head>
  <body>
    <div class="card">
      <!-- header, language switch, form markup here -->
      <!-- … your existing HTML form … -->
    </div>

    <!-- Social buttons markup here -->

    <script>
      // point API_BASE at your backend (no trailing slash here)
      const API_BASE = "https://api.copticnote.com";

      // translations object stays the same
      const translations = {
        en: {
          church: "Choose Church",
          helpChurch: "Select your parish so the list prints in the right place.",
          remembrance: "Remembrance",
          occasionRecently: "Recently",
          occasion40: "40th Day",
          occasionYearly: "Annually",
          categoryRecently: "Recently",
          category40: "40th Day",
          categoryYearly: "Annually",
          male: "Male",
          female: "Female",
          placeholderNames: "Enter names",
          submit: "Submit",
          ok: "Your names have been recorded.",
          err: "There was a problem. Please try again.",
          needOccasion: "Please choose at least one remembrance and enter names for each.",
          invalidNamesFormat: "Please enter valid names (letters only, avoid random symbols or numbers).",
        },
        ar: {
          church: "اختر الكنيسة",
          helpChurch: "اختر كنيستك لضمان طباعة الطلب في المكان الصحيح.",
          remembrance: "الذكرى",
          occasionRecently: "حديثًا",
          occasion40: "الأربعين",
          occasionYearly: "السنوية",
          categoryRecently: "حديثًا",
          category40: "الأربعين",
          categoryYearly: "السنوية",
          male: "رجال",
          female: "سيدات",
          placeholderNames: "اكتب الأسماء",
          submit: "إرسال",
          ok: "تم تسجيل الأسماء.",
          err: "حدث خطأ، يرجى المحاولة مرة أخرى.",
          needOccasion: "يرجى اختيار مناسبة واحدة على الأقل وإدخال أسماء لكل منها.",
          invalidNamesFormat: "يرجى إدخال أسماء صحيحة (حروف فقط وبدون رموز أو أرقام عشوائية).",
        },
      };

      let currentLang = "en";

      function applyTranslations() {
        const t = translations[currentLang];
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";
        document.getElementById("lbl-church").textContent = t.church;
        document.getElementById("help-church").textContent = t.helpChurch;
        document.getElementById("lbl-remembrance").textContent = t.remembrance;
        document.getElementById("lbl-occasion-recently").textContent = t.occasionRecently;
        document.getElementById("lbl-occasion-40").textContent = t.occasion40;
        document.getElementById("lbl-occasion-yearly").textContent = t.occasionYearly;
        document.getElementById("lbl-cat-recently").textContent = t.categoryRecently;
        document.getElementById("lbl-cat-40th").textContent = t.category40;
        document.getElementById("lbl-cat-yearly").textContent = t.categoryYearly;
        document.getElementById("lbl-male-recently").textContent = t.male;
        document.getElementById("lbl-female-recently").textContent = t.female;
        document.getElementById("lbl-male-40th").textContent = t.male;
        document.getElementById("lbl-female-40th").textContent = t.female;
        document.getElementById("lbl-male-yearly").textContent = t.male;
        document.getElementById("lbl-female-yearly").textContent = t.female;
        document.getElementById("male-recently").placeholder = t.placeholderNames;
        document.getElementById("female-recently").placeholder = t.placeholderNames;
        document.getElementById("male-40th").placeholder = t.placeholderNames;
        document.getElementById("female-40th").placeholder = t.placeholderNames;
        document.getElementById("male-yearly").placeholder = t.placeholderNames;
        document.getElementById("female-yearly").placeholder = t.placeholderNames;
        document.getElementById("submitBtn").textContent = t.submit;
      }

      document.getElementById("lang-en").addEventListener("click", () => {
        currentLang = "en";
        document.getElementById("lang-en").classList.add("active");
        document.getElementById("lang-ar").classList.remove("active");
        applyTranslations();
      });
      document.getElementById("lang-ar").addEventListener("click", () => {
        currentLang = "ar";
        document.getElementById("lang-ar").classList.add("active");
        document.getElementById("lang-en").classList.remove("active");
        applyTranslations();
      });

      applyTranslations();

      async function loadChurches() {
        try {
          const res = await fetch(`${API_BASE}/api/churches`);
          const data = await res.json();
          const select = document.getElementById("church");
          select.innerHTML = "";
          (data.churches || []).forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.name;
            select.appendChild(opt);
          });
        } catch (err) {
          console.error("Failed to load churches:", err);
        }
      }
      loadChurches();

      function hasLongRepeat(str) {
        return /(.)(\1){3,}/u.test(str);
      }
      function ratioNonAlnum(str) {
        const total = str.length || 1;
        const non = (str.match(/[^ \p{L}\p{N}\n]/gu) || []).length;
        return non / total;
      }
      function validateNamesContent(str, t) {
        const s = (str || "").trim();
        if (!s) return t.invalidNamesFormat;
        const parts = s.split(/[\n,]+/).map((x) => x.trim()).filter(Boolean);
        if (!parts.length) return t.invalidNamesFormat;
        for (const name of parts) {
          const letters = (name.match(/\p{L}/gu) || []).length;
          const digits = (name.match(/\d/g) || []).length;
          if (letters < 2) return t.invalidNamesFormat;
          if (digits > 0) return t.invalidNamesFormat;
          if (hasLongRepeat(name)) return t.invalidNamesFormat;
          if (ratioNonAlnum(name) > 0.25) return t.invalidNamesFormat;
        }
        return null;
      }

      function bindCategoryToggle(checkboxId, sectionId) {
        const cb = document.getElementById(checkboxId);
        const section = document.getElementById(sectionId);
        cb.addEventListener("change", () => {
          section.style.display = cb.checked ? "block" : "none";
          if (!cb.checked) {
            section.querySelectorAll("textarea").forEach((ta) => (ta.value = ""));
          }
        });
      }
      bindCategoryToggle("occ-recently", "section-recently");
      bindCategoryToggle("occ-40th", "section-40th");
      bindCategoryToggle("occ-yearly", "section-yearly");

      document.getElementById("commemorationForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const statusOk = document.getElementById("status-ok");
        const statusErr = document.getElementById("status-error");
        statusOk.style.display = "none";
        statusErr.style.display = "none";
        const t = translations[currentLang];

        const churchId = document.getElementById("church").value;
        const payload = {
          churchId,
          lang: currentLang,
          categories: {},
        };

        let hasCategory = false;
        const addCategory = (cbId, key, maleId, femaleId) => {
          const cb = document.getElementById(cbId);
          if (cb && cb.checked) {
            hasCategory = true;
            const maleNames = document.getElementById(maleId).value.trim();
            const femaleNames = document.getElementById(femaleId).value.trim();
            payload.categories[key] = { male: maleNames, female: femaleNames };
          }
        };

        addCategory("occ-recently", "recently", "male-recently", "female-recently");
        addCategory("occ-40th", "40th", "male-40th", "female-40th");
        addCategory("occ-yearly", "annually", "male-yearly", "female-yearly");

        if (!churchId) {
          statusErr.textContent = t.err;
          statusErr.style.display = "block";
          return;
        }
        if (!hasCategory) {
          statusErr.textContent = t.needOccasion;
          statusErr.style.display = "block";
          return;
        }
        // validate names in each category
        for (const key in payload.categories) {
          const cat = payload.categories[key];
          const maleErr = validateNamesContent(cat.male, t);
          const femaleErr = validateNamesContent(cat.female, t);
          if (maleErr) {
            statusErr.textContent = maleErr;
            statusErr.style.display = "block";
            return;
          }
          if (femaleErr) {
            statusErr.textContent = femaleErr;
            statusErr.style.display = "block";
            return;
          }
        }

        try {
          // NOTE: do not prefix /api here; the endpoint is /submit-commemoration
          const res = await fetch(`${API_BASE}/submit-commemoration`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (res.ok) {
            document.getElementById("commemorationForm").reset();
            ["section-recently", "section-40th", "section-yearly"].forEach((id) => {
              document.getElementById(id).style.display = "none";
            });
            statusOk.textContent = t.ok;
            statusOk.style.display = "block";
          } else {
            const j = await res.json().catch(() => ({}));
            statusErr.textContent = j.error || t.err;
            statusErr.style.display = "block";
          }
        } catch (err) {
          statusErr.textContent = t.err;
          statusErr.style.display = "block";
        }
      });
    </script>
  </body>
</html>
