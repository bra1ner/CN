<!doctype html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Coptic Note – Prayer Request</title>
    <meta
      name="description"
      content="Submit a private prayer note. Choose your church and your request will automatically print at that location."
    />
    <link rel="icon" type="image/svg+xml" href="assets/favors.svg" />

    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-RJ9ZRC3PW3"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-RJ9ZRC3PW3");
    </script>

    <style>
      /* Root colour palette: white background with dark red accents */
      :root {
        --bg: #faf7f2;
        --paper: #ffffff;
        --border: #e2e2e0;
        --text: #2a2a2a;
        --muted: #6c6c6b;
        --accent: #800000;
        --accent-light: #a52a2a;
        --gold: #c8a951; /* gold accent */
        --focus-ring: rgba(200, 169, 81, 0.3); /* gold highlight */

        /* Spacing + radius */
        --field-pad: 14px;
        --field-radius: 12px;

        /* Responsive helpers */
        --page-pad: clamp(12px, 2.5vw, 28px);
        --card-pad: clamp(16px, 3vw, 28px);
        --btn-pad-y: clamp(10px, 1.8vh, 14px);
        --btn-pad-x: clamp(14px, 3vw, 22px);
        --control-font: clamp(0.95rem, 0.9rem + 0.3vw, 1rem);
        --h1-size: clamp(1.25rem, 1.05rem + 1.2vw, 1.6rem);
        --note-size: clamp(0.82rem, 0.78rem + 0.2vw, 0.9rem);
        --social-size: clamp(48px, 7vw, 64px);
        --social-icon: clamp(22px, 3.2vw, 28px);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: var(--page-pad); /* responsive page padding */
        font-family: "Noto Sans", Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        flex-direction: column; /* so the social row sits under the card */
        gap: 12px; /* space between card and social buttons */
      }

      .card {
        background: var(--paper);
        border: 1px solid var(--border);
        border-radius: 16px;
        width: 100%;
        max-width: 600px; /* keeps a readable line-length */
        padding: var(--card-pad); /* responsive inner padding */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-inline: auto; /* keep centered */
      }

      /* ===== Header ===== */
      .header {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 16px;
        text-align: center;
      }

      .header img {
        height: clamp(40px, 6vw, 52px);
        width: auto;
        display: block;
      }

      h1 {
        margin: 0;
        font-size: var(--h1-size); /* fluid headline */
        font-weight: 700;
        color: var(--accent);
        text-align: center;
      }

      .form-group {
        margin-bottom: clamp(14px, 2.2vw, 20px);
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--accent);
        font-size: clamp(0.95rem, 0.9rem + 0.3vw, 1rem);
      }

      select,
      input[type="text"],
      textarea {
        display: block;
        width: 100%;
        border: 1px solid var(--border);
        border-radius: var(--field-radius);
        background: #fff;
        padding-block: clamp(10px, 1.8vh, 12px);
        padding-inline: var(--field-pad);
        font-size: var(--control-font); /* fluid control font size */
        color: var(--text);
        outline: none;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }

      select:focus,
      input[type="text"]:focus,
      textarea:focus {
        border-color: var(--gold);
        box-shadow: 0 0 0 3px var(--focus-ring);
      }

      /* Custom arrow for select */
      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%237d1a1a' d='M4 6l4 4 4-4z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px 16px;
        padding-right: calc(var(--field-pad) + 24px);
      }

      html[dir="rtl"] select {
        background-position: left 12px center;
        padding-left: calc(var(--field-pad) + 24px);
        padding-right: var(--field-pad);
      }

      /* Responsive textarea height */
      textarea {
        min-height: clamp(140px, 24vh, 260px);
        resize: vertical;
      }

      .note {
        font-size: var(--note-size); /* fluid small text */
        color: var(--muted);
      }

      button {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: var(--btn-pad-y) var(--btn-pad-x); /* bigger tap targets on small screens */
        font-size: var(--control-font);
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.15s ease, box-shadow 0.15s ease;
      }

      button:hover {
        background: var(--accent-light);
        box-shadow: 0 0 8px var(--gold);
      }

      /* === Language switch === */
      .lang-switch {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: clamp(8px, 1.8vw, 12px);
        margin: 0 0 12px;
        width: 100%;
        direction: ltr;
      }

      #lang-en {
        order: 0;
      }
      #lang-ar {
        order: 1;
      }

      .lang-switch button {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 8px 14px;
        border-radius: 8px;
        font-size: var(--control-font);
        line-height: 1;
        min-width: 110px;
        flex: 0 0 auto;
      }

      .lang-switch button.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      .status-message {
        margin-top: 12px;
        font-weight: 600;
      }

      .status-ok {
        color: #1d8e53;
      }

      .status-error {
        color: #b12b2b;
      }

      .field-helper {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-top: 6px;
      }

      .translate-row {
        display: flex;
        align-items: stretch;
        justify-content: space-between;
        gap: 8px;
        margin-top: 8px;
      }

      .translate-btn {
        background: #d3d3d3;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 8px 14px;
        border-radius: 8px;
        font-size: var(--control-font);
        line-height: 1;
        cursor: pointer;
        white-space: nowrap;
      }

      .translate-btn:hover {
        background: #f8f8f8;
      }

      .translate-btn.busy {
        width: auto !important;
        min-width: 0 !important;
        max-width: none !important;
      }

      /* ===== Buttons group under Prayer Note (Translate) ===== */
      .buttons-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: stretch;
      }

      /* ===== Submit + Commemoration row (FIXED) ===== */
      .form-actions {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 12px;
        margin-top: 14px;
        width: 100%;
      }

      /* LTR: push commemoration to the RIGHT */
      .form-actions #commemorationLinkInline {
        margin-left: auto;
      }

      /* RTL: push commemoration to the LEFT */
      html[dir="rtl"] .form-actions #commemorationLinkInline {
        margin-left: 0;
        margin-right: auto;
      }

      #submitBtn {
        margin-top: 0;
      }

      .commemoration-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: var(--btn-pad-y) var(--btn-pad-x);
        border-radius: 10px;
        background: #000;
        color: #fff;
        border: none;
        font-size: var(--control-font);
        font-weight: 600;
        line-height: 1;
        text-decoration: none;
        cursor: pointer;
        white-space: nowrap;
        width: fit-content; /* stretch only to text */
        transition: box-shadow 0.15s ease, transform 0.15s ease,
          background-color 0.15s ease;
      }

      .commemoration-btn:hover {
        box-shadow: 0 0 0 3px var(--focus-ring);
        transform: translateY(-1px);
        background: #111;
      }

      /* mobile stacking */
      @media (max-width: 420px) {
        .form-actions {
          flex-direction: column;
          align-items: stretch;
        }
        .form-actions > * {
          width: 100%;
        }
        .commemoration-btn {
          justify-content: center;
          width: 100%;
          margin-left: 0;
          margin-right: 0;
        }
      }

      /* === Social buttons strip UNDER the card === */
      .social-row {
        width: 100%;
        max-width: 600px; /* match .card */
        margin: 0 auto;
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .social-btn {
        width: var(--social-size);
        height: var(--social-size);
        background: #ffffff;
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        user-select: none;
        transition: box-shadow 0.15s ease, transform 0.15s ease,
          border-color 0.15s ease;
      }

      .social-btn:hover {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--focus-ring);
        transform: translateY(-1px);
      }

      .social-btn img {
        width: var(--social-icon);
        height: var(--social-icon);
        display: block;
      }

      .social-btn span {
        font-size: 22px;
        line-height: 1;
        color: var(--muted);
      }

      @media (max-width: 360px) {
        .field-helper {
          flex-direction: column;
          gap: 4px;
        }
        .lang-switch button {
          min-width: 96px;
        }
      }

      @media (min-width: 1100px) {
        .card {
          max-width: 640px;
        }
      }

      /* === PRINT THEMES === */
      @media print {
        html,
        body {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
        .no-print {
          display: none !important;
        }
        #print-slip {
          display: block !important;
        }
        .print-sheet {
          width: 80mm;
          padding: 6mm;
          box-sizing: border-box;
          font-family: "Noto Sans", Arial, sans-serif;
          line-height: 1.25;
          font-size: 12pt;
        }
        .print--note {
          background: #fff !important;
          color: #000 !important;
        }
        .print--note * {
          background: transparent !important;
          color: inherit !important;
          box-shadow: none !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="card">
      <div class="header">
        <img src="assets/coptic-note.svg" alt="Coptic Note logo" />
        <h1>Coptic Note</h1>
        <div style="width: 60px; height: 2px; background: var(--gold)"></div>
      </div>

      <!-- Language switch -->
      <div class="lang-switch">
        <button type="button" id="lang-en" class="active">English</button>
        <button type="button" id="lang-ar">العربية</button>
      </div>

      <!-- Navigation to commemoration page -->
      <div class="nav-row" style="display: none">
        <a
          class="nav-link"
          id="commemorationLink"
          href="https://copticnote.com/commemoration"
          >Commemoration</a
        >
      </div>

      <form id="prayerForm" novalidate>
        <div class="form-group">
          <label for="church" id="lbl-church">Choose Church</label>
          <select id="church" name="church" required aria-required="true"></select>
          <div class="note" id="help-church"></div>
        </div>

        <div class="form-group">
          <label for="name" id="lbl-name">Name (optional)</label>
          <input type="text" id="name" name="name" placeholder="Anonymous" />
        </div>

        <div class="form-group" id="group-note">
          <label for="note" id="lbl-note">Prayer Note</label>
          <textarea
            id="note"
            name="note"
            placeholder="Write your prayer here… اكتب صلاتك هنا…"
            maxlength="2000"
            required
          ></textarea>

          <div class="field-helper">
            <div class="note" id="note-hint">Max 300 words • 2000 characters.</div>
            <div class="note" id="note-count">0 / 300 • 0 / 2000</div>
          </div>

          <div class="translate-row">
            <div class="buttons-group">
              <button type="button" id="translateBtn" class="translate-btn">
                Translate
              </button>
            </div>
            <div class="note" id="translate-status"></div>
          </div>
        </div>

        <!-- Actions row -->
        <div class="form-actions">
          <button type="submit" id="submitBtn">Submit</button>

          <a
            class="commemoration-btn"
            id="commemorationLinkInline"
            href="https://copticnote.com/commemoration"
            >Commemoration</a
          >
        </div>

        <div class="status-message status-ok" id="status-ok" style="display: none"></div>
        <div class="status-message status-error" id="status-error" style="display: none"></div>
      </form>
    </div>

    <!-- Social buttons row under the card -->
    <div class="social-row" aria-label="Social links">
      <a
        class="social-btn"
        href="https://instagram.com/copticnote"
        aria-label="Instagram"
        target="_blank"
        rel="noopener noreferrer"
        ><img src="social/instagram.png" alt="Instagram"
      /></a>
      <a
        class="social-btn"
        href="https://discord.gg/7fxRTfNdC2"
        aria-label="Discord"
        target="_blank"
        rel="noopener noreferrer"
        ><img src="social/discord.png" alt="Discord"
      /></a>
      <a
        class="social-btn"
        href="https://www.linkedin.com/company/coptic-note/"
        aria-label="LinkedIn"
        target="_blank"
        rel="noopener noreferrer"
        ><img src="social/in.png" alt="LinkedIn"
      /></a>
      <a
        class="social-btn"
        href="https://x.com/CopticNote"
        aria-label="X / Twitter"
        target="_blank"
        rel="noopener noreferrer"
        ><img src="social/x.png" alt="X/Twitter"
      /></a>
      <a
        class="social-btn"
        href="https://facebook.com/CopticNote"
        aria-label="Facebook"
        target="_blank"
        rel="noopener noreferrer"
        ><img src="social/facebook.png" alt="Facebook"
      /></a>
    </div>

    <!-- Hidden container we populate and print -->
    <div id="print-slip" style="display: none"></div>

    <script>
      const API_BASE = "https://api.copticnote.com";

      const translations = {
        en: {
          church: "Choose Church",
          helpChurch: "Select your parish so the note prints in the right place.",
          name: "Name (optional)",
          note: "Prayer Note",
          placeholderNote: "Write your prayer here… اكتب صلاتك هنا…",
          submit: "Submit",
          ok: "Your request has been received.",
          err: "There was a problem. Please try again.",
          noteHint: "Max 300 words • 2000 characters.",
          overLimit:
            "Prayer Note must be 300 words or fewer and 2000 characters or fewer.",
          translateBtn: "Translate",
          translating: "Translating…",
          translateErrEmpty: "Write something to translate.",
          translateErrGeneric: "Translation failed. Please try again.",
          translatedToAr: "Translated to Arabic.",
          translatedToEn: "Translated to English.",
          invalidGibberish:
            "Please write meaningful text (avoid repeated letters, random symbols, or gibberish).",
          commemorationBtn: "Commemoration",
        },
        ar: {
          church: "اختر الكنيسة",
          helpChurch: "اختر كنيستك لضمان طباعة الطلب في المكان الصحيح.",
          name: "الاسم (اختياري)",
          note: "نص الصلاة",
          placeholderNote: "اكتب صلاتك هنا…",
          submit: "إرسال",
          ok: "تم استلام طلبك.",
          err: "حدث خطأ، يرجى المحاولة مرة أخرى.",
          noteHint: "الحد الأقصى ٣٠٠ كلمة • ٢٠٠٠ حرف.",
          overLimit: "يجب ألا يزيد نص الصلاة عن ٣٠٠ كلمة و٢٠٠٠ حرف.",
          translateBtn: "ترجمة",
          translating: "جارٍ الترجمة…",
          translateErrEmpty: "اكتب ما تريد ترجمته أولًا.",
          translateErrGeneric: "فشلت الترجمة. حاول مرة أخرى.",
          translatedToAr: "تمت الترجمة إلى العربية.",
          translatedToEn: "تمت الترجمة إلى الإنجليزية.",
          invalidGibberish: "يرجى كتابة نص مفهوم (بدون تكرار حروف أو رموز عشوائية).",
          commemorationBtn: "صلاة الترحيم",
        },
      };

      let currentLang = "en";

      function applyTranslations() {
        const t = translations[currentLang];
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";

        document.getElementById("lbl-church").textContent = t.church;
        document.getElementById("help-church").textContent = t.helpChurch;
        document.getElementById("lbl-name").textContent = t.name;
        document.getElementById("lbl-note").textContent = t.note;
        document.getElementById("note").placeholder = t.placeholderNote;

        document.getElementById("submitBtn").textContent = t.submit;
        document.getElementById("note-hint").textContent = t.noteHint;
        document.getElementById("translateBtn").textContent = t.translateBtn;

        const topLink = document.getElementById("commemorationLink");
        if (topLink) topLink.textContent = t.commemorationBtn;
        const inlineLink = document.getElementById("commemorationLinkInline");
        if (inlineLink) inlineLink.textContent = t.commemorationBtn;
      }

      document.getElementById("lang-en").addEventListener("click", () => {
        currentLang = "en";
        document.getElementById("lang-en").classList.add("active");
        document.getElementById("lang-ar").classList.remove("active");
        applyTranslations();
        syncButtonWidths();
      });

      document.getElementById("lang-ar").addEventListener("click", () => {
        currentLang = "ar";
        document.getElementById("lang-ar").classList.add("active");
        document.getElementById("lang-en").classList.remove("active");
        applyTranslations();
        syncButtonWidths();
      });

      applyTranslations();

      async function loadChurches() {
        try {
          const res = await fetch(`${API_BASE}/api/churches`);
          const data = await res.json();
          const select = document.getElementById("church");
          select.innerHTML = "";
          (data.churches || []).forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.name;
            select.appendChild(opt);
          });
        } catch (err) {
          console.error("Failed to load churches:", err);
        }
      }
      loadChurches();

      function countWords(text) {
        const matches = text.trim().match(/\S+/g);
        return matches ? matches.length : 0;
      }

      function trimToMaxWords(text, max) {
        const words = text.trim().match(/\S+/g) || [];
        if (words.length <= max) return text.trim();
        return words.slice(0, max).join(" ");
      }

      function updateNoteCounter() {
        const noteEl = document.getElementById("note");
        const countEl = document.getElementById("note-count");
        const words = countWords(noteEl.value);
        const chars = noteEl.value.length;
        countEl.textContent = `${words} / 300 • ${chars} / 2000`;
      }

      function hasLongRepeat(str) {
        return /(.)(\1){3,}/u.test(str);
      }

      function ratioNonAlnum(str) {
        const total = str.length || 1;
        const non = (str.match(/[^ \p{L}\p{N}\n]/gu) || []).length;
        return non / total;
      }

      function latinVowelRatio(str) {
        const latin = (str.match(/[A-Za-z]/g) || []).length;
        if (!latin) return 1;
        const vowels = (str.match(/[AEIOUYaeiouy]/g) || []).length;
        return vowels / latin;
      }

      function looksMostlyNumbers(str) {
        const digits = (str.match(/\d/g) || []).length;
        const letters = (str.match(/\p{L}/gu) || []).length;
        return digits > letters && digits >= 3;
      }

      function tooManyShortTokens(str) {
        const tokens = str.trim().match(/\S+/g) || [];
        if (tokens.length < 4) return false;
        const short = tokens.filter((w) => w.length <= 2).length;
        return short / tokens.length > 0.6;
      }

      function isLikelyGibberish(str) {
        const s = (str || "").trim();
        if (!s) return false;
        if (s.length < 3) return true;
        if (hasLongRepeat(s)) return true;
        if (ratioNonAlnum(s) > 0.35) return true;
        if (looksMostlyNumbers(s)) return true;
        if (tooManyShortTokens(s)) return true;
        if (latinVowelRatio(s) < 0.18) return true;
        return false;
      }

      function validateNoteContent(str, t) {
        if (isLikelyGibberish(str)) return t.invalidGibberish;
        return null;
      }

      const noteEl2 = document.getElementById("note");
      noteEl2.addEventListener("input", () => {
        if (countWords(noteEl2.value) > 300) {
          noteEl2.value = trimToMaxWords(noteEl2.value, 300);
        }
        if (noteEl2.value.length > 2000) {
          noteEl2.value = noteEl2.value.slice(0, 2000);
        }
        updateNoteCounter();
      });
      updateNoteCounter();

      document.getElementById("note").addEventListener("blur", () => {
        const t = translations[currentLang];
        const val = document.getElementById("note").value;
        const err = validateNoteContent(val, t);
        const statusErr = document.getElementById("status-error");
        if (err) {
          statusErr.textContent = err;
          statusErr.style.display = "block";
        } else {
          statusErr.style.display = "none";
        }
      });

      function withTimeout(promise, ms = 9000) {
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), ms);
        return Promise.race([
          (async () => {
            try {
              return await promise(controller.signal);
            } finally {
              clearTimeout(t);
            }
          })(),
        ]);
      }

      const translators = [
        async (text, source, target, signal) => {
          const res = await fetch("https://libretranslate.com/translate", {
            method: "POST",
            signal,
            headers: { "Content-Type": "application/json", Accept: "application/json" },
            body: JSON.stringify({ q: text, source, target, format: "text" }),
          });
          if (!res.ok) throw new Error(`LT_main_${res.status}`);
          const j = await res.json();
          if (!j.translatedText) throw new Error("LT_main_no_text");
          return j.translatedText;
        },
        async (text, source, target, signal) => {
          const res = await fetch("https://translate.astian.org/translate", {
            method: "POST",
            signal,
            headers: { "Content-Type": "application/json", Accept: "application/json" },
            body: JSON.stringify({ q: text, source, target, format: "text" }),
          });
          if (!res.ok) throw new Error(`LT_ast_${res.status}`);
          const j = await res.json();
          if (!j.translatedText) throw new Error("LT_ast_no_text");
          return j.translatedText;
        },
        async (text, source, target, signal) => {
          const res = await fetch("https://libretranslate.de/translate", {
            method: "POST",
            signal,
            headers: { "Content-Type": "application/json", Accept: "application/json" },
            body: JSON.stringify({ q: text, source, target, format: "text" }),
          });
          if (!res.ok) throw new Error(`LT_de_${res.status}`);
          const j = await res.json();
          if (!j.translatedText) throw new Error("LT_de_no_text");
          return j.translatedText;
        },
        async (text, source, target, signal) => {
          const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(
            text
          )}&langpair=${source}|${target}`;
          const res = await fetch(url, { signal, headers: { Accept: "application/json" } });
          if (!res.ok) throw new Error(`MM_${res.status}`);
          const j = await res.json();
          const out = j?.responseData?.translatedText;
          if (!out) throw new Error("MM_no_text");
          return out;
        },
      ];

      async function translateText(text, source, target) {
        const errors = [];
        for (const fn of translators) {
          try {
            const result = await withTimeout((signal) => fn(text, source, target, signal), 9000);
            return result;
          } catch (e) {
            errors.push(e?.message || String(e));
          }
        }
        throw new Error("all_providers_failed: " + errors.join(" | "));
      }

      function looksArabic(text) {
        return /[\u0600-\u06FF]/.test(text);
      }

      const translateBtn = document.getElementById("translateBtn");
      const translateStatus = document.getElementById("translate-status");

      async function handleTranslateClick() {
        const t = translations[currentLang];
        const ta = document.getElementById("note");
        const val = (ta.value || "").trim();

        translateStatus.textContent = "";
        if (!val) {
          translateStatus.textContent = t.translateErrEmpty;
          return;
        }

        const fromIsArabic = looksArabic(val);
        const source = fromIsArabic ? "ar" : "en";
        const target = fromIsArabic ? "en" : "ar";

        translateBtn.classList.add("busy");
        translateBtn.setAttribute("aria-busy", "true");

        translateBtn.disabled = true;
        const oldBtnText = translateBtn.textContent;
        translateBtn.textContent = t.translating;

        try {
          let out = await translateText(val, source, target);
          if (countWords(out) > 300) out = trimToMaxWords(out, 300);
          if (out.length > 2000) out = out.slice(0, 2000);
          ta.value = out;
          updateNoteCounter();
          ta.setAttribute("dir", target === "ar" ? "rtl" : "ltr");
          translateStatus.textContent = target === "ar" ? t.translatedToAr : t.translatedToEn;
        } catch (e) {
          console.error(e);
          translateStatus.textContent = `${t.translateErrGeneric} (${e.message || "error"})`;
        } finally {
          translateBtn.disabled = false;
          translateBtn.textContent = oldBtnText;
          translateBtn.classList.remove("busy");
          translateBtn.removeAttribute("aria-busy");
          syncButtonWidths();
        }
      }
      translateBtn.addEventListener("click", handleTranslateClick);

      function syncButtonWidths() {
        const tBtn = document.getElementById("translateBtn");
        const sBtn = document.getElementById("submitBtn");
        if (!tBtn || !sBtn) return;
        if (tBtn.classList.contains("busy")) return;

        tBtn.style.width = "";
        tBtn.style.minWidth = "";
        tBtn.style.maxWidth = "";
        sBtn.style.width = "";
        sBtn.style.minWidth = "";
        sBtn.style.maxWidth = "";

        requestAnimationFrame(() => {
          const tW = tBtn.offsetWidth;
          const sW = sBtn.offsetWidth;
          const maxW = Math.max(tW, sW);
          const w = maxW + "px";

          tBtn.style.width = w;
          tBtn.style.minWidth = w;
          tBtn.style.maxWidth = w;

          sBtn.style.width = w;
          sBtn.style.minWidth = w;
          sBtn.style.maxWidth = w;
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        syncButtonWidths();
      });

      let _sbwTimer;
      window.addEventListener("resize", () => {
        clearTimeout(_sbwTimer);
        _sbwTimer = setTimeout(syncButtonWidths, 120);
      });

      document.querySelectorAll(".social-row a.social-btn").forEach((a) => {
        a.setAttribute("target", "_blank");
        a.setAttribute("rel", "noopener noreferrer");
      });

      document.getElementById("prayerForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const statusOk = document.getElementById("status-ok");
        const statusErr = document.getElementById("status-error");
        statusOk.style.display = "none";
        statusErr.style.display = "none";

        const churchId = document.getElementById("church").value;
        const name = document.getElementById("name").value.trim();
        const note = document.getElementById("note").value.trim();

        if (!churchId || !note) {
          statusErr.textContent = translations[currentLang].err;
          statusErr.style.display = "block";
          return;
        }

        const gibErr = validateNoteContent(note, translations[currentLang]);
        if (gibErr) {
          statusErr.textContent = gibErr;
          statusErr.style.display = "block";
          return;
        }

        if (countWords(note) > 300 || note.length > 2000) {
          statusErr.textContent = translations[currentLang].overLimit;
          statusErr.style.display = "block";
          return;
        }

        const payload = {
          churchId,
          name: name || "Anonymous",
          note,
          prayerType: "note",
          lang: currentLang,
        };

        try {
          const res = await fetch(`${API_BASE}/submit-prayer`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (res.ok) {
            document.getElementById("prayerForm").reset();
            updateNoteCounter();
            document.getElementById("translate-status").textContent = "";
            statusOk.textContent = translations[currentLang].ok;
            statusOk.style.display = "block";
            syncButtonWidths();
          } else {
            const j = await res.json().catch(() => ({}));
            statusErr.textContent = j.error || translations[currentLang].err;
            statusErr.style.display = "block";
          }
        } catch (err) {
          statusErr.textContent = translations[currentLang].err;
          statusErr.style.display = "block";
        }
      });
    </script>
  </body>
</html>
