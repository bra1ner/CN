<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coptic Note – Prayer Request</title>
  <meta name="description" content="Submit a private prayer note or a memorial prayer for the deceased. Choose your church and your request will automatically print at that location." />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
  <style>
    /* Root colour palette: white background with dark red accents */
    :root {
      --bg: #f9f9f7;
      --paper: #ffffff;
      --border: #e2e2e0;
      --text: #2a2a2a;
      --muted: #6c6c6b;
      --accent: #7d1a1a;
      --accent-light: #a52a2a;
      --focus-ring: rgba(125, 26, 26, 0.3);
      --field-pad: 14px;
      --field-radius: 12px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: "Noto Sans", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 24px;
    }
    .card {
      background: var(--paper);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 24px;
    }
    .header img {
      height: 32px;
      width: 32px;
    }
    h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent);
    }
    .form-group {
      margin-bottom: 18px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--accent);
    }
    select, input[type="text"], textarea {
      display: block;
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--field-radius);
      background: #fff;
      padding-block: 12px;
      padding-inline: var(--field-pad);
      font-size: 1rem;
      color: var(--text);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    select:focus, input[type="text"]:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--focus-ring);
    }
    /* Custom arrow for select to ensure equal padding on both sides */
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%237d1a1a' d='M4 6l4 4 4-4z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px 16px;
      padding-right: calc(var(--field-pad) + 24px);
    }
    /* RTL support: move arrow to left */
    html[dir="rtl"] select {
      background-position: left 12px center;
      padding-left: calc(var(--field-pad) + 24px);
      padding-right: var(--field-pad);
    }
    textarea {
      min-height: 160px;
      resize: vertical;
    }
    .radio-group {
      display: flex;
      gap: 16px;
    }
    .radio-group label {
      font-weight: normal;
      color: var(--text);
    }
    .note {
      font-size: 0.85rem;
      color: var(--muted);
    }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    button:hover {
      background: var(--accent-light);
    }
    .lang-switch {
      display: flex;
      gap: 8px;
      margin-top: -8px;
      margin-bottom: 18px;
    }
    .lang-switch button {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.85rem;
    }
    .lang-switch button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .status-message {
      margin-top: 12px;
      font-weight: 600;
    }
    .status-ok { color: #1d8e53; }
    .status-error { color: #b12b2b; }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <img src="assets/logo-coptic-note.svg" alt="Coptic Note logo" />
      <h1>✝ Coptic Note</h1>
    </div>

    <!-- Language switch -->
    <div class="lang-switch">
      <button type="button" id="lang-en" class="active">English</button>
      <button type="button" id="lang-ar">العربية</button>
    </div>

    <form id="prayerForm" novalidate>
      <div class="form-group">
        <label for="church" id="lbl-church">Choose Church</label>
        <select id="church" name="church" required aria-required="true"></select>
        <div class="note" id="help-church"></div>
      </div>

      <div class="form-group">
        <label for="name" id="lbl-name">Name (optional)</label>
        <input type="text" id="name" name="name" placeholder="Anonymous" />
      </div>

      <div class="form-group">
        <label id="lbl-prayerType">Prayer Type</label>
        <div class="radio-group" id="prayerType-group">
          <label><input type="radio" name="prayerType" value="note" checked /> <span id="lbl-type-note">Prayer Note</span></label>
          <label><input type="radio" name="prayerType" value="deceased" /> <span id="lbl-type-deceased">Prayer for the Deceased</span></label>
        </div>
      </div>

      <!-- Occasion and names (shown only for deceased) -->
      <div class="form-group" id="group-occasion" style="display:none;">
        <label id="lbl-occasion">Occasion</label>
        <div class="radio-group">
          <label><input type="radio" name="occasion" value="40th" /> <span id="lbl-occasion-40">40th Day</span></label>
          <label><input type="radio" name="occasion" value="yearly" /> <span id="lbl-occasion-yearly">Yearly</span></label>
        </div>
      </div>
      <div class="form-group" id="group-names" style="display:none;">
        <label for="deceasedNames" id="lbl-names">Names</label>
        <textarea id="deceasedNames" name="deceasedNames" placeholder="Enter names"></textarea>
      </div>

      <!-- Note (shown only for prayer note) -->
      <div class="form-group" id="group-note">
        <label for="note" id="lbl-note">Prayer Note</label>
        <textarea id="note" name="note" placeholder="Write your prayer here… اكتب صلاتك هنا…"></textarea>
      </div>

      <button type="submit" id="submitBtn">Submit</button>
      <div class="status-message status-ok" id="status-ok" style="display:none;"></div>
      <div class="status-message status-error" id="status-error" style="display:none;"></div>
    </form>
  </div>

  <script>
    // Base URL for API requests. Update this if your API lives on a different domain.
    const API_BASE = 'https://api.copticnote.com';

    // Translations for English and Arabic
    const translations = {
      en: {
        church: 'Choose Church',
        helpChurch: 'Select your parish so the note prints in the right place.',
        name: 'Name (optional)',
        type: 'Prayer Type',
        typeNote: 'Prayer Note',
        typeDeceased: 'Prayer for the Deceased',
        occasion: 'Occasion',
        occasion40: '40th Day',
        occasionYearly: 'Yearly',
        names: 'Names',
        note: 'Prayer Note',
        placeholderNames: 'Enter names',
        placeholderNote: 'Write your prayer here… اكتب صلاتك هنا…',
        submit: 'Submit',
        ok: 'Your request has been received.',
        err: 'There was a problem. Please try again.'
      },
      ar: {
        church: 'اختر الكنيسة',
        helpChurch: 'اختر كنيستك لضمان طباعة الطلب في المكان الصحيح.',
        name: 'الاسم (اختياري)',
        type: 'نوع الطلب',
        typeNote: 'طلب صلاة',
        typeDeceased: 'صلاة للمتوفين',
        occasion: 'المناسبة',
        occasion40: 'الأربعين',
        occasionYearly: 'سنوية',
        names: 'الأسماء',
        note: 'نص الصلاة',
        placeholderNames: 'اكتب الأسماء',
        placeholderNote: 'اكتب صلاتك هنا…',
        submit: 'إرسال',
        ok: 'تم استلام طلبك.',
        err: 'حدث خطأ، يرجى المحاولة مرة أخرى.'
      }
    };

    let currentLang = 'en';

    function applyTranslations() {
      const t = translations[currentLang];
      document.documentElement.lang = currentLang;
      document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
      document.getElementById('lbl-church').textContent = t.church;
      document.getElementById('help-church').textContent = t.helpChurch;
      document.getElementById('lbl-name').textContent = t.name;
      document.getElementById('lbl-prayerType').textContent = t.type;
      document.getElementById('lbl-type-note').textContent = t.typeNote;
      document.getElementById('lbl-type-deceased').textContent = t.typeDeceased;
      document.getElementById('lbl-occasion').textContent = t.occasion;
      document.getElementById('lbl-occasion-40').textContent = t.occasion40;
      document.getElementById('lbl-occasion-yearly').textContent = t.occasionYearly;
      document.getElementById('lbl-names').textContent = t.names;
      document.getElementById('lbl-note').textContent = t.note;
      document.getElementById('deceasedNames').placeholder = t.placeholderNames;
      document.getElementById('note').placeholder = t.placeholderNote;
      document.getElementById('submitBtn').textContent = t.submit;
    }

    // Language switchers
    document.getElementById('lang-en').addEventListener('click', () => {
      currentLang = 'en';
      document.getElementById('lang-en').classList.add('active');
      document.getElementById('lang-ar').classList.remove('active');
      applyTranslations();
    });
    document.getElementById('lang-ar').addEventListener('click', () => {
      currentLang = 'ar';
      document.getElementById('lang-ar').classList.add('active');
      document.getElementById('lang-en').classList.remove('active');
      applyTranslations();
    });
    applyTranslations();

    // Populate church dropdown
    async function loadChurches() {
      try {
        const res = await fetch(`${API_BASE}/api/churches`);
        const data = await res.json();
        const select = document.getElementById('church');
        select.innerHTML = '';
        data.churches.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.name;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error('Failed to load churches:', err);
      }
    }
    loadChurches();

    // Show/hide fields based on prayer type
    function updateTypeUI() {
      const val = document.querySelector('input[name="prayerType"]:checked').value;
      const isDeceased = (val === 'deceased');
      document.getElementById('group-note').style.display = isDeceased ? 'none' : '';
      document.getElementById('group-occasion').style.display = isDeceased ? '' : 'none';
      document.getElementById('group-names').style.display = isDeceased ? '' : 'none';
      // Set required attributes
      document.getElementById('note').required = !isDeceased;
      document.querySelectorAll('input[name="occasion"]').forEach(el => {
        el.required = isDeceased;
        el.checked = false;
      });
      document.getElementById('deceasedNames').required = isDeceased;
      if (isDeceased) {
        document.getElementById('note').value = '';
      } else {
        document.getElementById('deceasedNames').value = '';
      }
    }
    document.querySelectorAll('input[name="prayerType"]').forEach(el => {
      el.addEventListener('change', updateTypeUI);
    });
    updateTypeUI();

    // Form submit
    document.getElementById('prayerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const statusOk = document.getElementById('status-ok');
      const statusErr = document.getElementById('status-error');
      statusOk.style.display = 'none';
      statusErr.style.display = 'none';
      const churchId = document.getElementById('church').value;
      const name = document.getElementById('name').value.trim();
      const prayerType = document.querySelector('input[name="prayerType"]:checked').value;
      const note = document.getElementById('note').value.trim();
      const occasion = document.querySelector('input[name="occasion"]:checked')?.value || '';
      const deceasedNames = document.getElementById('deceasedNames').value.trim();
      // Validation (client-side only, server will validate again)
      if (!churchId) {
        statusErr.textContent = translations[currentLang].err;
        statusErr.style.display = 'block';
        return;
      }
      if (prayerType === 'note' && !note) {
        statusErr.textContent = translations[currentLang].err;
        statusErr.style.display = 'block';
        return;
      }
      if (prayerType === 'deceased') {
        if (!occasion || !deceasedNames) {
          statusErr.textContent = translations[currentLang].err;
          statusErr.style.display = 'block';
          return;
        }
      }
      // Build payload
      const payload = {
        churchId,
        name: name || 'Anonymous',
        note,
        prayerType,
        deceasedOccasion: occasion,
        deceasedNames,
        lang: currentLang
      };
      try {
        const res = await fetch(`${API_BASE}/submit-prayer`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          document.getElementById('prayerForm').reset();
          updateTypeUI();
          statusOk.textContent = translations[currentLang].ok;
          statusOk.style.display = 'block';
        } else {
          const j = await res.json().catch(() => ({}));
          statusErr.textContent = j.error || translations[currentLang].err;
          statusErr.style.display = 'block';
        }
      } catch (err) {
        statusErr.textContent = translations[currentLang].err;
        statusErr.style.display = 'block';
      }
    });
  </script>
</body>
</html>